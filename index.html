<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IKC Lab Booking - v1.0.4</title>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
  <style>
    .version { position: absolute; top: 10px; left: 10px; font-size: 12px; color: #999; font-weight: bold; }
    .lang-switcher { position: absolute; top: 10px; right: 10px; }
    .lang-btn { background: #fff; border: 2px solid #0066cc; color: #0066cc; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.3s; }
    .lang-btn:hover { background: #0066cc; color: #fff; }
    
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    .box { background: #fff; padding: 30px; width: 400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative; }
    .hidden { display: none; }
    h2 { text-align: center; color: #333; margin-bottom: 15px; }
    
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee; }
    .tab { padding: 10px 15px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; font-size: 13px; }
    .tab.active { color: #0066cc; border-bottom: 2px solid #0066cc; }

    label { font-size: 13px; color: #666; font-weight: bold; display: block; margin-top: 10px; }
    input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    .main-btn { background: #0066cc; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; transition: background 0.3s; }
    .main-btn:hover { background: #004a99; }
    
    .links { margin-top: 15px; text-align: center; font-size: 13px; }
    .links a { color: #0066cc; text-decoration: none; cursor: pointer; display: block; margin-top: 8px; }
  </style>
</head>
<body>

<div class="version">v1.0.4</div>
<div class="lang-switcher"><button class="lang-btn" onclick="toggleLanguage()" id="langBtn">EN</button></div>

<div id="loginPage" class="box">
  <h2 data-key="loginTitle">Giriş Yap</h2>
  <div class="tabs">
    <div class="tab active" onclick="setUserType('student', 'login')" id="login-student-tab" data-key="studentTab">Öğrenci</div>
    <div class="tab" onclick="setUserType('academic', 'login')" id="login-academic-tab" data-key="academicTab">Akademik Personel</div>
  </div>
  <label id="loginIdLabel" data-key="studentIdLabel">Öğrenci Numarası</label>
  <input id="loginId" type="text" placeholder="ID">
  <label data-key="passLabel">Şifre</label>
  <input id="loginPass" type="password" placeholder="******">
  <button class="main-btn" onclick="login()" data-key="signInBtn">Giriş Yap</button>
  <div class="links">
    <a onclick="switchPage('registerPage')" data-key="createAccLink">Yeni Hesap Oluştur</a>
    <a onclick="switchPage('forgotPage')" data-key="forgotPassLink">Şifremi Unuttum</a>
  </div>
</div>

<div id="registerPage" class="box hidden">
  <h2 data-key="regTitle">Kayıt Ol</h2>
  <div class="tabs">
    <div class="tab active" onclick="setUserType('student', 'reg')" id="reg-student-tab" data-key="studentTab">Öğrenci</div>
    <div class="tab" onclick="setUserType('academic', 'reg')" id="reg-academic-tab" data-key="academicTab">Akademik Personel</div>
  </div>
  <label id="regIdLabel" data-key="studentIdLabel">Öğrenci Numarası</label>
  <input id="regId" type="text" placeholder="ID">
  <label data-key="nameLabel">Ad Soyad</label>
  <input id="regFullName" type="text" placeholder="Full Name">
  <label data-key="passLabel">Şifre</label>
  <input id="regPass" type="password">
  <button class="main-btn" onclick="register()" data-key="signUpBtn">Kayıt Ol</button>
  <div class="links"><a onclick="switchPage('loginPage')" data-key="backBtn">Geri Dön</a></div>
</div>

<div id="forgotPage" class="box hidden">
  <h2 data-key="forgotPassLink">Şifre Sıfırlama</h2>
  <div class="tabs">
    <div class="tab active" onclick="setUserType('student', 'forgot')" id="forgot-student-tab" data-key="studentTab">Öğrenci</div>
    <div class="tab" onclick="setUserType('academic', 'forgot')" id="forgot-academic-tab" data-key="academicTab">Akademik Personel</div>
  </div>
  <input id="forgotId" type="text" placeholder="ID">
  <button class="main-btn" onclick="sendResetEmail()" data-key="sendLinkBtn">Gönder</button>
  <div class="links"><a onclick="switchPage('loginPage')" data-key="backBtn">Geri Dön</a></div>
</div>

<div id="bookingPage" class="box hidden">
  <h2 id="welcomeMsg">Welcome</h2>
  <label data-key="dateLabel">Tarih</label>
  <input id="date" type="date">
  <label data-key="timeLabel">Saat</label>
  <input id="time" type="time">
  <button class="main-btn" onclick="bookAppointment()" data-key="bookBtn">Randevu Al</button>
  <button class="main-btn" style="background:#555;" onclick="logout()" data-key="logoutBtn">Logout</button>
</div>

<script>
  const { Client, Account, Databases, ID } = Appwrite;
  const client = new Client().setEndpoint('https://cloud.appwrite.io/v1').setProject('6981c32f00212fb21625');
  const account = new Account(client);
  const databases = new Databases(client);

  const DATABASE_ID = '6981c42a00202c6cdf0e';
  const COLLECTION_ID = 'appointments';
  const REDIRECT_URL = "https://oktaykemah.github.io/lab-randevu/"; 

  let currentUser = null;
  let currentLang = localStorage.getItem('lang') || 'tr';
  let selectedUserType = 'student';

  const translations = {
    tr: {
      loginTitle: "Giriş Yap", studentIdLabel: "Öğrenci Numarası", academicIdLabel: "Personel ID", 
      passLabel: "Şifre", signInBtn: "Giriş Yap", createAccLink: "Yeni Hesap Oluştur", 
      forgotPassLink: "Şifremi Unuttum", regTitle: "Kayıt Ol", nameLabel: "Ad Soyad", 
      signUpBtn: "Kayıt Ol", backBtn: "Geri Dön", studentTab: "Öğrenci", academicTab: "Akademik Personel",
      sendLinkBtn: "Sıfırlama Linki Gönder", dateLabel: "Tarih Seçin", timeLabel: "Saat Seçin", 
      bookBtn: "Randevu Al", logoutBtn: "Çıkış Yap", verifyMsg: "Lütfen e-postanızı doğrulayın!",
      successBook: "Randevu başarıyla alındı!"
    },
    en: {
      loginTitle: "Login", studentIdLabel: "Student ID", academicIdLabel: "Academic ID",
      passLabel: "Password", signInBtn: "Sign In", createAccLink: "Create New Account", 
      forgotPassLink: "Forgot Password?", regTitle: "Register", nameLabel: "Full Name", 
      signUpBtn: "Sign Up", backBtn: "Back", studentTab: "Student", academicTab: "Academic Personnel",
      sendLinkBtn: "Send Reset Link", dateLabel: "Select Date", timeLabel: "Select Time", 
      bookBtn: "Book Now", logoutBtn: "Logout", verifyMsg: "Please verify your email!",
      successBook: "Appointment booked!"
    }
  };

  function setUserType(type, page) {
    selectedUserType = type;
    document.querySelectorAll(`.tab`).forEach(t => t.classList.remove('active'));
    document.getElementById(`${page}-${type}-tab`).classList.add('active');
    
    const labelKey = type === 'student' ? 'studentIdLabel' : 'academicIdLabel';
    if(document.getElementById(`${page}IdLabel`)) {
      document.getElementById(`${page}IdLabel`).innerText = translations[currentLang][labelKey];
    }
  }

  function getEmailFromId(userId) {
    const domain = selectedUserType === 'student' ? "@ogr.ikc.edu.tr" : "@ikc.edu.tr";
    return userId.trim() + domain;
  }

  function updateUI() {
    document.querySelectorAll('[data-key]').forEach(el => {
      const key = el.getAttribute('data-key');
      el.innerText = translations[currentLang][key];
    });
    document.getElementById('langBtn').innerText = currentLang === 'tr' ? 'EN' : 'TR';
    setUserType(selectedUserType, 'login');
  }

  function toggleLanguage() {
    currentLang = currentLang === 'tr' ? 'en' : 'tr';
    localStorage.setItem('lang', currentLang);
    updateUI();
  }

  async function register() {
    const idVal = document.getElementById("regId").value;
    const fullName = document.getElementById("regFullName").value;
    const pass = document.getElementById("regPass").value;
    const email = getEmailFromId(idVal);
    try {
      await account.create(ID.unique(), email, pass, fullName);
      await account.createEmailSession(email, pass);
      await account.createVerification(REDIRECT_URL);
      alert(currentLang === 'tr' ? "Doğrulama maili gönderildi: " + email : "Verification email sent: " + email);
      await account.deleteSession('current');
      switchPage('loginPage');
    } catch (e) { alert(e.message); }
  }

  async function login() {
    const idVal = document.getElementById("loginId").value;
    const pass = document.getElementById("loginPass").value;
    const email = getEmailFromId(idVal);
    try {
      await account.createEmailSession(email, pass);
      currentUser = await account.get();
      if (!currentUser.emailVerification) {
        alert(translations[currentLang].verifyMsg);
        await account.deleteSession('current');
        return;
      }
      document.getElementById("welcomeMsg").innerText = (currentLang === 'tr' ? "Merhaba, " : "Welcome, ") + currentUser.name;
      switchPage('bookingPage');
    } catch (e) { alert(currentLang === 'tr' ? "Giriş başarısız!" : "Login failed!"); }
  }

  async function bookAppointment() {
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    try {
      await databases.createDocument(DATABASE_ID, COLLECTION_ID, ID.unique(), {
        name: currentUser.name, date: date, time: time
      });
      alert(translations[currentLang].successBook);
    } catch (e) { alert(e.message); }
  }

  function switchPage(id) {
    document.querySelectorAll('.box').forEach(b => b.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }

  async function logout() { await account.deleteSession('current'); location.reload(); }
  window.onload = () => updateUI();
</script>
</body>
</html>
